<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iNaturalist Species Counts</title>
<style>
    table {
        border-collapse: collapse;
        width: 100%;
    }
    th, td {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 8px;
    }
    th {
        background-color: #f2f2f2;
        cursor: pointer;
    }
    .italic {
        font-style: italic;
    }
</style>
</head>
<body>

<h2>iNaturalist Species Counts</h2>

<table id="species-table">
  <thead>
    <tr>
      <th onclick="sortTable(0)">Taxon ID</th>
      <th onclick="sortTable(1)">Taxon Name</th>
      <th onclick="sortTable(2)">Iconic Taxon Name</th>
      <th onclick="sortTable(3)">count CNC23</th>
      <th onclick="sortTable(4)">total count</th>
      <th onclick="sortTable(5)">Ratio (%)</th>
    </tr>
  </thead>
  <tbody id="species-data">
    <!-- Data will be dynamically added here -->
  </tbody>
</table>

<script>
    function sortTable(n) {
        var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById("species-table");
        switching = true;
        dir = "asc";
        while (switching) {
            switching = false;
            rows = table.rows;
            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i + 1].getElementsByTagName("TD")[n];
                if (dir == "asc") {
                    if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                        shouldSwitch= true;
                        break;
                    }
                } else if (dir == "desc") {
                    if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                        shouldSwitch= true;
                        break;
                    }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount ++;
            } else {
                if (switchcount == 0 && dir == "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }
    }

    // Function to fetch data for a given page
    function fetchData(pageNumber) {
        return fetch(`https://api.inaturalist.org/v2/observations/species_counts?project_id=153723&quality_grade=research&page=${pageNumber}&fields=taxon.id,taxon.name,taxon.iconic_taxon_name,count`)
            .then(response => response.json());
    }

    // Function to fetch count data for taxon IDs
    function fetchCountData(taxonIds) {
        const taxonIdString = taxonIds.join(',');
        return fetch(`https://api.inaturalist.org/v2/observations/species_counts?place_id=120582&taxon_id=${taxonIdString}&quality_grade=research&fields=count`)
            .then(response => response.json());
    }

    // Function to process data and update table
    function processData(results) {
        // Get the tbody element to append data
        const tbody = document.getElementById('species-data');
        const taxonIds = results.map(result => result.taxon.id);

        // Fetch count data for taxon IDs
        fetchCountData(taxonIds)
            .then(countData => {
                // Map taxon ID to count
                const countMap = {};
                countData.results.forEach(entry => {
                    countMap[entry.taxon.id] = entry.count;
                });

                // Loop through results and create table rows
                results.forEach(result => {
                    const taxonId = result.taxon.id;
                    const taxonName = result.taxon.name;
                    const iconicTaxonName = result.taxon.iconic_taxon_name;
                    const originalCount = result.count;
                    const newCount = countMap[taxonId];
                    const ratio = newCount === 0 ? 'N/A' : (originalCount / newCount * 100).toFixed(2) + '%';

                    // Create a table row and append to tbody
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><a href="https://inaturalist.lu/taxa/${taxonId}" target="_blank">${taxonId}</a></td>
                        <td><span class="italic">${taxonName}</span></td>
                        <td>${iconicTaxonName}</td>
                        <td>${originalCount}</td>
                        <td>${newCount}</td>
                        <td>${ratio}</td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .catch(error => {
                console.error('Error fetching count data:', error);
            });
    }

    // Function to fetch all data recursively
    function fetchAllData(pageNumber = 1) {
        fetchData(pageNumber)
            .then(data => {
                const results = data.results;
                processData(results);
                const nextPage = data.page + 1;
                if (nextPage <= Math.ceil(data.total_results / data.per_page)) {
