<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iNaturalist Species Observations</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
            text-align: left;
        }
        td.italic {
            font-style: italic;
        }
        a {
            color: blue;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .controls {
            margin-bottom: 20px;
        }
        .controls label, .controls select, .controls input, .controls button {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <h1>Species Observations</h1>
    <div class="controls">
        <label for="filter">Filter:</label>
        <select id="filter">
            <option value="verifiable=true" selected>Verifiable</option>
            <option value="quality_grade=research">Research Quality</option>
        </select>

        <label for="rank">Taxonomic Rank (hrank):</label>
        <select id="rank">
            <option value="genus" selected>Genus</option>
            <option value="species">Species</option>
        </select>

        <label for="start-date">Start Date (d1):</label>
        <input type="date" id="start-date">

        <label for="end-date">End Date (d2):</label>
        <input type="date" id="end-date">

        <button id="run-query">Run Query</button>
    </div>
    <p id="total-results">Total species detected: Loading...</p>
    <table>
        <thead>
            <tr>
                <th>Taxon Name</th>
                <th>Taxon ID</th>
                <th>Iconic Taxon Name</th>
                <th>Observation Count</th>
            </tr>
        </thead>
        <tbody id="data-table">
            <!-- Data will be populated here -->
        </tbody>
    </table>

    <script>
        // Helper function to format the date for display as dd/mm/yyyy
        function formatDateForDisplay(dateStr) {
            if (!dateStr) return "";
            const date = new Date(dateStr);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Helper function to convert date from dd/mm/yyyy to yyyy-mm-dd
        function formatDateForApi(dateStr) {
            if (!dateStr) return "";
            return new Date(dateStr).toISOString().split('T')[0];
        }

        document.getElementById('run-query').addEventListener('click', () => {
            // Get selected filter and rank
            const filter = document.getElementById('filter').value;
            const hrank = document.getElementById('rank').value;

            // Get selected dates
            const d1Raw = document.getElementById('start-date').value;
            const d2Raw = document.getElementById('end-date').value;

            // Format dates for API
            const d1 = formatDateForApi(d1Raw);
            const d2 = formatDateForApi(d2Raw);

            // Build the API URL dynamically
            let apiUrl = `https://api.inaturalist.org/v2/observations/species_counts?${filter}&hrank=${hrank}&place_id=120582&fields=taxon.iconic_taxon_name,taxon.id,taxon.name,count`;
            if (d1) apiUrl += `&d1=${d1}`;
            if (d2) apiUrl += `&d2=${d2}`;

            // Fetch data from the API
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Display total results
                    const totalResults = data.total_results || 0;
                    document.getElementById('total-results').textContent = `Total species detected: ${totalResults}`;

                    // Select the table body
                    const tableBody = document.getElementById('data-table');
                    tableBody.innerHTML = ""; // Clear previous data

                    // Ensure data exists and iterate over it
                    if (data.results) {
                        data.results.forEach(item => {
                            const row = document.createElement('tr');

                            // Taxon Name (italic)
                            const taxonNameCell = document.createElement('td');
                            taxonNameCell.textContent = item.taxon.name || 'N/A';
                            taxonNameCell.classList.add('italic');
                            row.appendChild(taxonNameCell);

                            // Taxon ID (hyperlink)
                            const taxonIdCell = document.createElement('td');
                            if (item.taxon.id) {
                                const link = document.createElement('a');
                                link.href = `https://inaturalist.lu/taxa/${item.taxon.id}`;
                                link.textContent = item.taxon.id;
                                link.target = "_blank"; // Open link in a new tab
                                taxonIdCell.appendChild(link);
                            } else {
                                taxonIdCell.textContent = 'N/A';
                            }
                            row.appendChild(taxonIdCell);

                            // Iconic Taxon Name
                            const iconicTaxonCell = document.createElement('td');
                            iconicTaxonCell.textContent = item.taxon.iconic_taxon_name || 'N/A';
                            row.appendChild(iconicTaxonCell);

                            // Observation Count
                            const countCell = document.createElement('td');
                            countCell.textContent = item.count || 'N/A';
                            row.appendChild(countCell);

                            // Append the row to the table body
                            tableBody.appendChild(row);
                        });
                    } else {
                        const row = document.createElement('tr');
                        const cell = document.createElement('td');
                        cell.textContent = "No data available";
                        cell.colSpan = 4;
                        row.appendChild(cell);
                        tableBody.appendChild(row);
                    }
                })
                .catch(error => {
                    console.error("Error fetching the data:", error);
                    document.getElementById('total-results').textContent = "Total species detected: Error loading data";
                    const tableBody = document.getElementById('data-table');
                    tableBody.innerHTML = ""; // Clear previous data
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.textContent = "Error loading data";
                    cell.colSpan = 4;
                    row.appendChild(cell);
                    tableBody.appendChild(row);
                });
        });
    </script>
</body>
</html>
