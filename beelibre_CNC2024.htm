<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Observation Results</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <div>
        <label for="projectIdSelect">Select Project ID:</label>
        <select id="projectIdSelect">
            <option value="city-nature-challenge-2024-luxembourg">City Nature Challenge 2024 Luxembourg</option>
            <option value="city-nature-challenge-2023-luxembourg" selected>City Nature Challenge 2023 Luxembourg</option>
            <option value="city-nature-challenge-2022-luxembourg">City Nature Challenge 2022 Luxembourg</option>
        </select>
        <button onclick="refreshData()">Refresh Data</button>
    </div>

    <table id="observationTable">
        <tr>
            <th>User ID</th>
            <th>User Name</th>
            <th>User Observations</th>
            <th>Obs Osmia (<a id="osmiaLink" href="#" target="_blank"></a>)</th>
            <th>Obs Bombus pascuorum (<a id="bombusLink" href="#" target="_blank"></a>)</th>
            <th>Obs Subgenus Bombus (<a id="subgenusLink" href="#" target="_blank"></a>)</th>
            <th>Obs Andrena (<a id="andrenaLink" href="#" target="_blank"></a>)</th>
        </tr>
    </table>

    <script>
        // Function to make API call and return results
        function getObservers(project_id, taxon_id) {
            const url = `https://api.inaturalist.org/v2/observations/observers?project_id=${project_id}&taxon_id=${taxon_id}&fields=user.login&order_by=observation_count`;
            return fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to retrieve data from the API for taxon ID ${taxon_id}. Status code: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => [data.results, taxon_id, data.total_results, url])
                .catch(error => {
                    console.error('Error:', error);
                    return [[], taxon_id, 0, url];
                });
        }

        // Function to generate the URL for user observations
        function generateUserObservationsUrl(user_login, project_id) {
            return `https://inaturalist.lu/observations?project_id=${project_id}&user_id=${user_login}&verifiable=any`;
        }

        // Function to populate table with data
        function populateTable(project_id) {
            const table = document.getElementById("observationTable");

            // Get observers for each taxon ID
            Promise.all([
                getObservers(project_id, 57674),
                getObservers(project_id, 55637),
                getObservers(project_id, 538903),
                getObservers(project_id, 57669)
            ]).then(results => {
                const [observersOsmia, taxonIdOsmia, totalResultsOsmia, osmiaUrl] = results[0];
                const [observersBombus, taxonIdBombus, totalResultsBombus, bombusUrl] = results[1];
                const [observersSubgenus, taxonIdSubgenus, totalResultsSubgenus, subgenusUrl] = results[2];
                const [observersAndrena, taxonIdAndrena, totalResultsAndrena, andrenaUrl] = results[3];

                // Display total results and set hyperlinks for each Obs
                document.getElementById("osmiaLink").textContent = totalResultsOsmia;
                document.getElementById("osmiaLink").href = `https://inaturalist.lu/observations?order_by=observation_count&${osmiaUrl.split('?')[1]}`;

                document.getElementById("bombusLink").textContent = totalResultsBombus;
                document.getElementById("bombusLink").href = `https://inaturalist.lu/observations?order_by=observation_count&${bombusUrl.split('?')[1]}`;

                document.getElementById("subgenusLink").textContent = totalResultsSubgenus;
                document.getElementById("subgenusLink").href = `https://inaturalist.lu/observations?order_by=observation_count&${subgenusUrl.split('?')[1]}`;

                document.getElementById("andrenaLink").textContent = totalResultsAndrena;
                document.getElementById("andrenaLink").href = `https://inaturalist.lu/observations?order_by=observation_count&${andrenaUrl.split('?')[1]}`;

                // Determine the maximum number of rows needed
                const maxRows = Math.max(observersOsmia.length, observersBombus.length, observersSubgenus.length, observersAndrena.length);

                // Clear table
                table.innerHTML = '';

                // Write each result to the HTML table
                for (let i = 0; i < maxRows; i++) {
                    const row = table.insertRow();
                    
                    // Add data for Osmia
                    if (i < observersOsmia.length) {
                        const observerOsmia = observersOsmia[i];
                        const userLogin = observerOsmia.user.login;
                        const userObservationsUrl = generateUserObservationsUrl(userLogin, project_id);
                        row.insertCell().textContent = observerOsmia.user.id;
                        row.insertCell().textContent = observerOsmia.user.login;
                        row.insertCell().innerHTML = `<a href="${userObservationsUrl}" target="_blank">Link</a>`;
                        row.insertCell().textContent = observerOsmia.observation_count;
                    } else {
                        row.insertCell().colSpan = 4;
                    }
                    
                    // Add data for Bombus pascuorum
                    if (i < observersBombus.length) {
                        row.insertCell().textContent = observersBombus[i].observation_count;
                    } else {
                        row.insertCell();
                    }
                    
                    // Add data for Subgenus Bombus
                    if (i < observersSubgenus.length) {
                        row.insertCell().textContent = observersSubgenus[i].observation_count;
                    } else {
                        row.insertCell();
                    }
                    
                    // Add data for Andrena
                    if (i < observersAndrena.length) {
                        row.insertCell().textContent = observersAndrena[i].observation_count;
                    } else {
                        row.insertCell();
                    }
                }
            });
        }

        // Refresh
